import express from "express";
import fs from "fs";
import fetch from "node-fetch";

const app = express();
const apiUrl = "https://rtovehicleinfo.com/new_project/api/vehicle-info";
const apiKey = "f70cc0cc33617d1903db6c69d008db1";
const userAgent = "Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 Chrome/129.0 Mobile Safari/537.36";

app.get("/", async (req, res) => {
  res.setHeader("Content-Type", "application/json; charset=utf-8");
  res.setHeader("Access-Control-Allow-Origin", "*");

  if (!req.query.q) {
    return res.status(400).json({ error: "missing vehicle number" });
  }

  const vehicleId = req.query.q.trim().toUpperCase();
  if (!/^[A-Z0-9]+$/.test(vehicleId)) {
    return res.status(400).json({ error: "invalid vehicle format" });
  }

  const payload = JSON.stringify({ vehicleId });

  try {
    const r = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "User-Agent": userAgent,
        "Host": "rtovehicleinfo.com",
        "Connection": "Keep-Alive",
        "Accept-Encoding": "gzip"
      },
      body: payload
    });

    let data;
    try {
      data = await r.json();
    } catch {
      data = { raw_response: await r.text() };
    }

    const log = {
      vehicle: vehicleId,
      ip: req.ip,
      time: new Date().toISOString(),
      response: data
    };

    const file = "vehicle.js";
    let arr = [];

    if (fs.existsSync(file)) {
      let raw = fs.readFileSync(file, "utf8").trim();
      raw = raw.replace(/^var vehicleData = /, "").replace(/;$/, "");
      arr = JSON.parse(raw);
    }

    arr.push(log);
    fs.writeFileSync(file, "var vehicleData = " + JSON.stringify(arr, null, 2) + ";");

    res.status(r.status).end(JSON.stringify(data, null, 2));
  } catch (e) {
    res.status(500).json({ error: "server error" });
  }
});

app.listen(3000);
